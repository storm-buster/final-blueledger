import { ethers } from "hardhat";
import fs from "fs";
import path from "path";

async function main() {
  console.log("ðŸš€ Starting Carbon Credit Blockchain System deployment...\n");

  const [deployer] = await ethers.getSigners();
  console.log("ðŸ‘¤ Deploying contracts with account:", deployer.address);
  console.log("ðŸ’° Account balance:", (await deployer.provider.getBalance(deployer.address)).toString(), "\n");

  // Deploy CarbonRegistry
  console.log("ðŸ“œ Deploying CarbonRegistry...");
  const CarbonRegistry = await ethers.getContractFactory("CarbonRegistry");
  const registry = await CarbonRegistry.deploy();
  await registry.waitForDeployment();
  const registryAddress = await registry.getAddress();
  console.log("âœ… CarbonRegistry deployed to:", registryAddress);

  // Deploy MerkleTreeUtils
  console.log("\nðŸ“œ Deploying MerkleTreeUtils...");
  const MerkleTreeUtils = await ethers.getContractFactory("MerkleTreeUtils");
  const merkleUtils = await MerkleTreeUtils.deploy();
  await merkleUtils.waitForDeployment();
  const merkleUtilsAddress = await merkleUtils.getAddress();
  console.log("âœ… MerkleTreeUtils deployed to:", merkleUtilsAddress);

  // Deploy OracleConsumer
  console.log("\nðŸ“œ Deploying OracleConsumer...");
  const OracleConsumer = await ethers.getContractFactory("OracleConsumer");
  const oracle = await OracleConsumer.deploy();
  await oracle.waitForDeployment();
  const oracleAddress = await oracle.getAddress();
  console.log("âœ… OracleConsumer deployed to:", oracleAddress);

  // Deploy MultiSigWallet
  console.log("\nðŸ“œ Deploying MultiSigWallet...");
  const MultiSigWallet = await ethers.getContractFactory("MultiSigWallet");
  const multiSig = await MultiSigWallet.deploy(
    deployer.address, // verifier
    deployer.address, // admin
    deployer.address  // oracle
  );
  await multiSig.waitForDeployment();
  const multiSigAddress = await multiSig.getAddress();
  console.log("âœ… MultiSigWallet deployed to:", multiSigAddress);

  // Deploy CarbonCreditToken
  console.log("\nðŸ“œ Deploying CarbonCreditToken...");
  const CarbonCreditToken = await ethers.getContractFactory("CarbonCreditToken");
  const token = await CarbonCreditToken.deploy(registryAddress);
  await token.waitForDeployment();
  const tokenAddress = await token.getAddress();
  console.log("âœ… CarbonCreditToken deployed to:", tokenAddress);

  // Setup contracts
  console.log("\nâš™ï¸  Setting up contracts...");

  // Approve verifier in registry
  console.log("   â†’ Approving verifier...");
  await registry.approveVerifier(deployer.address, true);

  // Save deployment addresses
  const deploymentInfo = {
    network: (await ethers.provider.getNetwork()).name,
    chainId: (await ethers.provider.getNetwork()).chainId.toString(),
    deployer: deployer.address,
    timestamp: new Date().toISOString(),
    contracts: {
      CarbonRegistry: registryAddress,
      MerkleTreeUtils: merkleUtilsAddress,
      OracleConsumer: oracleAddress,
      MultiSigWallet: multiSigAddress,
      CarbonCreditToken: tokenAddress,
    },
  };

  const deploymentsDir = path.join(__dirname, "deployments");
  if (!fs.existsSync(deploymentsDir)) {
    fs.mkdirSync(deploymentsDir, { recursive: true });
  }

  const deploymentFile = path.join(
    deploymentsDir,
    `${deploymentInfo.network}-${Date.now()}.json`
  );
  fs.writeFileSync(deploymentFile, JSON.stringify(deploymentInfo, null, 2));
  fs.writeFileSync(
    path.join(deploymentsDir, "latest.json"),
    JSON.stringify(deploymentInfo, null, 2)
  );

  console.log("\nðŸ“ Deployment info saved to:", deploymentFile);
  console.log("\nðŸŽ‰ Deployment completed successfully!\n");

  console.log("ðŸ“‹ Contract Addresses:");
  console.log("   CarbonRegistry:", registryAddress);
  console.log("   MerkleTreeUtils:", merkleUtilsAddress);
  console.log("   OracleConsumer:", oracleAddress);
  console.log("   MultiSigWallet:", multiSigAddress);
  console.log("   CarbonCreditToken:", tokenAddress);
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });